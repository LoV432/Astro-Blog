---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Pagination from '../../components/Pagination.astro';
import Search from '../../components/Search.astro';
import PostCards from '../../components/PostCards.astro';
import { SITE_TITLE, SITE_DESCRIPTION, API } from '../../config';

const { tag } = Astro.params
var api = API + "/api/posts?filters[tags][tag][$eq]="+ tag +"&fields[0]=heading&fields[1]=createdAt&fields[2]=slug&fields[3]=description&populate[tags][fields]=tag&populate[cover][fields][0]=formats&pagination[pageSize]=" + PAGESIZE
let search: string = ""

if (Astro.url.searchParams.get('page')){
	api = api + "&pagination[page]=" + Astro.url.searchParams.get('page')
}
if (Astro.url.searchParams.get('search')){
	api = api + "&filters%5Bheading%5D%5B$contains%5D=" + Astro.url.searchParams.get('search')
	search = "&search=" + Astro.url.searchParams.get('search')
}


const posts  =  await fetch(api).then(res => res.json())
const totalPages = posts.meta.pagination.pageCount
const currentPage = posts.meta.pagination.page
---

<!DOCTYPE html>
<html lang="en" class=" bg-[#121212] text-zinc-200">
	<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	<body class="min-h-screen grid grid-rows-[auto,1fr,auto]">
		<Header />
		<main class="mt-10">
			<Search action={"/tag/" + tag} placeholder={"Search #" + tag} />
			<PostCards posts={posts}/>
			<Pagination totalPages={totalPages} currentPage={currentPage} search={search} tag={"/tag/" + tag}/>
		</main>
		<Footer />
	</body>
</html>
